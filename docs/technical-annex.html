<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Technical annex | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes</title>
<meta name="author" content="Gilberto Camara">
<meta name="author" content="Rolf Simoes">
<meta name="author" content="Felipe Souza">
<meta name="author" content="Felipe Menino">
<meta name="author" content="Charlotte Pelletier">
<meta name="author" content="Pedro R. Andrade">
<meta name="author" content="Karine Ferreira">
<meta name="author" content="Gilberto Queiroz">
<meta name="description" content="This Chapter contains technical details on the algorithms available in sits. It is intended to support those that want to understand how the package works and also want to contribute to its...">
<meta name="generator" content="bookdown 0.39 with bs4_book()">
<meta property="og:title" content="Technical annex | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes">
<meta property="og:type" content="book">
<meta property="og:image" content="/images/cover_sits_book.png">
<meta property="og:description" content="This Chapter contains technical details on the algorithms available in sits. It is intended to support those that want to understand how the package works and also want to contribute to its...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Technical annex | sits: Satellite Image Time Series Analysis on Earth Observation Data Cubes">
<meta name="twitter:description" content="This Chapter contains technical details on the algorithms available in sits. It is intended to support those that want to understand how the package works and also want to contribute to its...">
<meta name="twitter:image" content="/images/cover_sits_book.png">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><link href="libs/IBM_Plex_Serif-0.4.9/font.css" rel="stylesheet">
<link href="libs/IBM_Plex_Mono-0.4.9/font.css" rel="stylesheet">
<script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<style type="text/css">
    /* Used with Pandoc 2.11+ new --citeproc when CSL is used */
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
          margin-bottom: 0em;
        }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title=""><strong>sits</strong>: Satellite Image Time Series Analysis on Earth Observation Data Cubes</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li><a class="" href="setup.html">Setup</a></li>
<li><a class="" href="acknowledgements.html">Acknowledgements</a></li>
<li><a class="" href="introduction.html">Introduction</a></li>
<li><a class="" href="earth-observation-data-cubes.html">Earth observation data cubes</a></li>
<li><a class="" href="operations-on-data-cubes.html">Operations on data cubes</a></li>
<li><a class="" href="working-with-time-series.html">Working with time series</a></li>
<li><a class="" href="improving-the-quality-of-training-samples.html">Improving the quality of training samples</a></li>
<li><a class="" href="machine-learning-for-data-cubes.html">Machine learning for data cubes</a></li>
<li><a class="" href="classification-of-raster-data-cubes.html">Classification of raster data cubes</a></li>
<li><a class="" href="bayesian-smoothing-for-post-processing.html">Bayesian smoothing for post-processing</a></li>
<li><a class="" href="validation-and-accuracy-measurements.html">Validation and accuracy measurements</a></li>
<li><a class="" href="uncertainty-and-active-learning.html">Uncertainty and active learning</a></li>
<li><a class="" href="ensemble-prediction-from-multiple-models.html">Ensemble prediction from multiple models</a></li>
<li><a class="" href="object-based-time-series-image-analysis.html">Object-based time series image analysis</a></li>
<li><a class="" href="data-visualisation-in-sits.html">Data visualisation in sits</a></li>
<li><a class="active" href="technical-annex.html">Technical annex</a></li>
<li><a class="" href="references.html">References</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="technical-annex" class="section level1 unnumbered">
<h1>Technical annex<a class="anchor" aria-label="anchor" href="#technical-annex"><i class="fas fa-link"></i></a>
</h1>
<p>This Chapter contains technical details on the algorithms available in <code>sits</code>. It is intended to support those that want to understand how the package works and also want to contribute to its development.</p>
<div id="adding-functions-to-the-sits-api" class="section level2 unnumbered">
<h2>Adding functions to the <code>sits</code> API<a class="anchor" aria-label="anchor" href="#adding-functions-to-the-sits-api"><i class="fas fa-link"></i></a>
</h2>
<div id="general-principles" class="section level3 unnumbered">
<h3>General principles<a class="anchor" aria-label="anchor" href="#general-principles"><i class="fas fa-link"></i></a>
</h3>
<p>New functions that build on the <code>sits</code> API should follow the general principles below.</p>
<ul>
<li><p>The target audience for <code>sits</code> is the community of remote sensing experts with Earth Sciences background who want to use state-of-the-art data analysis methods with minimal investment in programming skills. The design of the <code>sits</code> API considers the typical workflow for land classification using satellite image time series and thus provides a clear and direct set of functions, which are easy to learn and master.</p></li>
<li><p>For this reason, we welcome contributors that provide useful additions to the existing API, such as new ML/DL classification algorithms. In case of a new API function, before making a pull request please raise an issue stating your rationale for a new function.</p></li>
<li><p>Most functions in <code>sits</code> use the S3 programming model with a strong emphasis on generic methods wich are specialized depending on the input data type. See for example the implementation of the <code><a href="https://rdrr.io/pkg/sits/man/sits_bands.html">sits_bands()</a></code> function.</p></li>
<li><p>Please do not include contributed code using the S4 programming model. Doing so would break the structure and the logic of existing code. Convert your code from S4 to S3.</p></li>
<li><p>Use generic functions as much as possible, as they improve modularity and maintenance. If your code has decision points using <code>if-else</code> clauses, such as <code>if A, do X; else do Y</code> consider using generic functions.</p></li>
<li><p>Functions that use the <code>torch</code> package use the R6 model to be compatible with that package. See for example, the code in <code>sits_tempcnn.R</code> and <code>api_torch.R</code>. To convert <code>pyTorch</code> code to R and include it is straightforward. Please see the <a href="https://e-sensing.github.io/sitsbook/technical-annex.html">Technical Annex</a> of the sits on-line book.</p></li>
<li><p>The sits code relies on the packages of the <code>tidyverse</code> to work with tables and list. We use <code>dplyr</code> and <code>tidyr</code> for data selection and wrangling, <code>purrr</code> and <code>slider</code> for loops on lists and table, <code>lubridate</code> to handle dates and times.</p></li>
</ul>
</div>
<div id="adherence-to-the-sits-data-types" class="section level3 unnumbered">
<h3>Adherence to the <code>sits</code> data types<a class="anchor" aria-label="anchor" href="#adherence-to-the-sits-data-types"><i class="fas fa-link"></i></a>
</h3>
<p>The <code>sits</code> package in built on top of three data types: time series tibble, data cubes and models. Most <code>sits</code> functions have one or more of these types as inputs and one of them as return values. The time series tibble contains data and metadata. The first six columns contain the metadata: spatial and temporal information, the label assigned to the sample, and the data cube from where the data has been extracted. The time_series column contains the time series data for each spatiotemporal location. All time series tibbles are objects of class <code>sits</code>.</p>
<p>The <code>cube</code> data type is designed to store metadata about image files. In principle, images which are part of a data cube share the same geographical region, have the same bands, and have been regularized to fit into a pre-defined temporal interval. Data cubes in <code>sits</code> are organized by tiles. A tile is an element of a satellite’s mission reference system, for example MGRS for Sentinel-2 and WRS2 for Landsat. A <code>cube</code> is a tibble where each row contains information about data covering one tile. Each row of the cube tibble contains a column named <code>file_info</code>; this column contains a list that stores a tibble</p>
<p>The <code>cube</code> data type is specialised in <code>raster_cube</code> (ARD images), <code>vector_cube</code> (ARD cube with segmentation vectors). <code>probs_cube</code> (probabilities produced by classification algorithms on raster data), <code>probs_vector_cube</code>(probabilites generated by vector classification of segments), <code>uncertainty_cube</code> (cubes with uncertainty information), and <code>class_cube</code> (labelled maps). See the code in <code>sits_plot.R</code> as an example of specialisation of <code>plot</code> to handle different classes of raster data.</p>
<p>All ML/DL models in <code>sits</code> which are the result of <code>sits_train</code> belong to the <code>ml_model</code> class. In addition, models are assigned a second class, which is unique to ML models (e.g, <code>rfor_model</code>, <code>svm_model</code>) and generic for all DL <code>torch</code> based models (<code>torch_model</code>). The class information is used for plotting models and for establishing if a model can run on GPUs.</p>
</div>
<div id="literal-values-error-messages-and-testing" class="section level3 unnumbered">
<h3>Literal values, error messages, and testing<a class="anchor" aria-label="anchor" href="#literal-values-error-messages-and-testing"><i class="fas fa-link"></i></a>
</h3>
<p>The internal <code>sits</code> code has no literal values, which are all stored in the YAML configuration files <code>./inst/extdata/config.yml</code> and <code>./inst/extdata/config_internals.yml</code>. The first file contains configuration parameters that are relevant to users, related to visualisation and plotting; the second contains parameters that are relevant only for developers. These values are accessible using the <code>.conf</code> function. For example, the value of the default size for ploting COG files is accessed using the command <code>.conf["plot", "max_size"]</code>.</p>
<p>Error messages are also stored outside of the code in the YAML configuration file <code>./inst/extdata/config_messages.yml</code>. These values are accessible using the <code>.conf</code> function. For example, the error associated to an invalid NA value for an input parameter is accessible using th function <code>.conf("messages", ".check_na_parameter")</code>.</p>
<p>We strive for high code coverage (&gt; 90%). Every parameter of all <code>sits</code> function (including internal ones) is checked for consistency. Please see <code>api_check.R</code>.</p>
</div>
<div id="supporting-new-stac-based-image-catalogues" class="section level3 unnumbered">
<h3>Supporting new STAC-based image catalogues<a class="anchor" aria-label="anchor" href="#supporting-new-stac-based-image-catalogues"><i class="fas fa-link"></i></a>
</h3>
<p>If you want to include a STAC-based catalogue not yet supported by <code>sits</code>, we encourage you to look at existing implementations of catalogues such as Microsoft Planetary Computer (MPC), Digital Earth Africa (DEA) and AWS. STAC-based catalogues in <code>sits</code> are associated to YAML description files, which are available in the directory <code>.inst/exdata/sources</code>. For example, the YAML file <code>config_source_mpc.yml</code> describes the contents of the MPC collections supported by <code>sits</code>. Please first provide an YAML file which lists the detailed contents of the new catalogue you wish to include. Follow the examples provided.</p>
<p>After writing the YAML file, you need to consider how to access and query the new catalogue. The entry point for access to all catalogues is the <code>sits_cube.stac_cube()</code> function, which in turn calls a sequence of functions which are described in the generic interface <code>api_source.R</code>. Most calls of this API are handled by the functions of <code>api_source_stac.R</code> which provides an interface to the <code>rstac</code> package and handles STAC queries.</p>
<p>Each STAC catalogue is different. The STAC specification allows providers to implement their data descriptions with specific information. For this reason, the generic API described in <code>api_source.R</code> needs to be specialized for each provider. Whenever a provider needs specific implementations of parts of the STAC protocol, we include them in separate files. For example, <code>api_source_mpc.R</code> implements specific quirks of the MPC platform. Similarly, specific support for CDSE (Copernicus Data Space Environment) is available in <code>api_source_cdse.R</code>.</p>
</div>
<div id="including-new-methods-for-machine-learning" class="section level3 unnumbered">
<h3>Including new methods for machine learning<a class="anchor" aria-label="anchor" href="#including-new-methods-for-machine-learning"><i class="fas fa-link"></i></a>
</h3>
<p>This section provides guidance for experts that want to include new methods for machine learning that work in connection with <code>sits</code>. The discussion below assumes familiarity with the R language. Developers should consult Hadley Wickham’s excellent book <a href="https://adv-r.hadley.nz/">Advanced R</a>, especially Chapter 10 on “Function Factories”.</p>
<p>All machine learning and deep learning algorithm in <code>sits</code> follow the same logic; all models are created by <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code>. This function has two parameters: (a) <code>samples</code>, a set of time series with the training samples; (b) <code>ml_method</code>, a function that fits the model to the input data. The result is a function that is passed on to <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code> to classify time series or data cubes. The structure of <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code> is simple, as shown below.</p>
<div class="sourceCode" id="cb258"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sits_train</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span>, <span class="va">ml_method</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># train a ml classifier with the given data</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">ml_method</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span>  <span class="co"># return a valid machine learning method</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>In R terms, <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code> is a function factory, or a function that makes functions. Such behavior is possible because functions are first-class objects in R. In other words, they can be bound to a name in the same way that variables are. A second propriety of R is that functions capture (enclose) the environment in which they are created. In other words, when a function is returned as a result of another function, the internal variables used to create it are available inside its environment. In programming language, this technique is called “closure”.</p>
<p>The following definition from Wikipedia captures the purpose of clousures: <em>“Operationally, a closure is a record storing a function together with an environment. The environment is a mapping associating each free variable of the function with the value or reference to which the name was bound when the closure was created. A closure allows the function to access those captured variables through the closure’s copies of their values or references, even when the function is invoked outside their scope.”</em></p>
<p>In <code>sits</code>, the properties of closures are used as a basis for making training and classification independent. The return of <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code> is a model that contains information on how to classify input values, as well as information on the samples used to train the model.</p>
<p>To ensure all models work in the same fashion, machine learning functions in <code>sits</code> also share the same data structure for prediction. This data structure is created by <code><a href="https://rdrr.io/pkg/sits/man/sits_predictors.html">sits_predictors()</a></code>, which transforms the time series tibble into a set of values suitable for using as training data, as shown in the following example.</p>
<div class="sourceCode" id="cb259"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"samples_matogrosso_mod13q1"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_predictors.html">sits_predictors</a></span><span class="op">(</span><span class="va">samples_matogrosso_mod13q1</span><span class="op">)</span></span>
<span><span class="va">pred</span></span></code></pre></div>
<pre><code>#&gt; # A tibble: 1,837 × 94
#&gt;    sample_id label  NDVI1 NDVI2 NDVI3 NDVI4 NDVI5 NDVI6 NDVI7 NDVI8 NDVI9 NDVI10
#&gt;        &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
#&gt;  1         1 Pastu… 0.500 0.485 0.716 0.654 0.591 0.662 0.734 0.739 0.768  0.797
#&gt;  2         2 Pastu… 0.364 0.484 0.605 0.726 0.778 0.829 0.762 0.762 0.643  0.610
#&gt;  3         3 Pastu… 0.577 0.674 0.639 0.569 0.596 0.623 0.650 0.650 0.637  0.646
#&gt;  4         4 Pastu… 0.597 0.699 0.789 0.792 0.794 0.72  0.646 0.705 0.757  0.810
#&gt;  5         5 Pastu… 0.388 0.491 0.527 0.660 0.677 0.746 0.816 0.816 0.825  0.835
#&gt;  6         6 Pastu… 0.350 0.345 0.364 0.429 0.506 0.583 0.660 0.616 0.580  0.651
#&gt;  7         7 Pastu… 0.490 0.527 0.543 0.583 0.594 0.605 0.616 0.627 0.622  0.644
#&gt;  8         8 Pastu… 0.435 0.574 0.395 0.392 0.518 0.597 0.648 0.774 0.786  0.798
#&gt;  9         9 Pastu… 0.396 0.473 0.542 0.587 0.649 0.697 0.696 0.695 0.699  0.703
#&gt; 10        10 Pastu… 0.354 0.387 0.527 0.577 0.626 0.723 0.655 0.655 0.646  0.536
#&gt; # ℹ 1,827 more rows
#&gt; # ℹ 82 more variables: NDVI11 &lt;dbl&gt;, NDVI12 &lt;dbl&gt;, NDVI13 &lt;dbl&gt;, NDVI14 &lt;dbl&gt;,
#&gt; #   NDVI15 &lt;dbl&gt;, NDVI16 &lt;dbl&gt;, NDVI17 &lt;dbl&gt;, NDVI18 &lt;dbl&gt;, NDVI19 &lt;dbl&gt;,
#&gt; #   NDVI20 &lt;dbl&gt;, NDVI21 &lt;dbl&gt;, NDVI22 &lt;dbl&gt;, NDVI23 &lt;dbl&gt;, EVI1 &lt;dbl&gt;,
#&gt; #   EVI2 &lt;dbl&gt;, EVI3 &lt;dbl&gt;, EVI4 &lt;dbl&gt;, EVI5 &lt;dbl&gt;, EVI6 &lt;dbl&gt;, EVI7 &lt;dbl&gt;,
#&gt; #   EVI8 &lt;dbl&gt;, EVI9 &lt;dbl&gt;, EVI10 &lt;dbl&gt;, EVI11 &lt;dbl&gt;, EVI12 &lt;dbl&gt;, EVI13 &lt;dbl&gt;,
#&gt; #   EVI14 &lt;dbl&gt;, EVI15 &lt;dbl&gt;, EVI16 &lt;dbl&gt;, EVI17 &lt;dbl&gt;, EVI18 &lt;dbl&gt;, …</code></pre>
<p>The predictors tibble is organized as a combination of the “X” and “Y” values used by machine learning algorithms. The first two columns are <code>sample_id</code> and <code>label</code>. The other columns contain the data values, organized by band and time. For machine learning methods that are not time-sensitive, such as random forest, this organization is sufficient for training. In the case of time-sensitive methods such as <code>tempCNN</code>, further arrangements are necessary to ensure the tensors have the right dimensions. Please refer to the <code><a href="https://rdrr.io/pkg/sits/man/sits_tempcnn.html">sits_tempcnn()</a></code> source code for an example of how to adapt the prediction table to appropriate <code>torch</code> tensor.</p>
<p>Some algorithms require data normalization. Therefore, the <code><a href="https://rdrr.io/pkg/sits/man/sits_predictors.html">sits_predictors()</a></code> code is usually combined with methods that extract statistical information and then normalize the data, as in the example below.</p>
<div class="sourceCode" id="cb261"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Data normalization</span></span>
<span><span class="va">ml_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_stats.html">sits_stats</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span><span class="co"># extract the training samples</span></span>
<span><span class="va">train_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_predictors.html">sits_predictors</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span><span class="co"># normalize the training samples</span></span>
<span><span class="va">train_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_pred_normalize.html">sits_pred_normalize</a></span><span class="op">(</span>pred <span class="op">=</span> <span class="va">train_samples</span>, stats <span class="op">=</span> <span class="va">ml_stats</span><span class="op">)</span></span></code></pre></div>
<p>The following example shows the implementation of the LightGBM algorithm, designed to efficiently handle large-scale datasets and perform fast training and inference <span class="citation"><a href="references.html#ref-Ke2017">[95]</a></span>. Gradient boosting is a machine learning technique that builds an ensemble of weak prediction models, typically decision trees, to create a stronger model. LightGBM specifically focuses on optimizing the training and prediction speed, making it particularly suitable for large datasets. The example builds a model using the <code>lightgbm</code> package. This model will then be applied later to obtain a classification.</p>
<p>Since LightGBM is a gradient boosting model, it uses part of the data as testing data to improve the model’s performance. The split between the training and test samples is controlled by a parameter, as shown in the following code extract.</p>
<div class="sourceCode" id="cb262"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># split the data into training and validation datasets</span></span>
<span><span class="co"># create partitions different splits of the input data</span></span>
<span><span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_pred_sample.html">sits_pred_sample</a></span><span class="op">(</span><span class="va">train_samples</span>,</span>
<span>  frac <span class="op">=</span> <span class="va">validation_split</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Remove the lines used for validation</span></span>
<span><span class="va">sel</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">train_samples</span><span class="op">$</span><span class="va">sample_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">test_samples</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span></span>
<span><span class="va">train_samples</span> <span class="op">&lt;-</span> <span class="va">train_samples</span><span class="op">[</span><span class="va">sel</span>, <span class="op">]</span></span></code></pre></div>
<p>To include the <code>lightgbm</code> package as part of <code>sits</code>, we need to create a new training function which is compatible with the other machine learning methods of the package and will be called by <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code>. For compatibility, this new function will be called <code>sits_lightgbm()</code>. Its implementation uses two functions from the <code>lightgbm</code>: (a) <code><a href="https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.html">lgb.Dataset()</a></code>, which transforms training and test samples into internal structures; (b) <code><a href="https://rdrr.io/pkg/lightgbm/man/lgb.train.html">lgb.train()</a></code>, which trains the model.</p>
<p>The parameters of <code><a href="https://rdrr.io/pkg/lightgbm/man/lgb.train.html">lightgbm::lgb.train()</a></code> are: (a) <code>boosting_type</code>, boosting algorithm; (b) <code>objective</code>, classification objective (c) <code>num_iterations</code>, number of runs; (d) <code>max_depth</code>, maximum tree depth; (d) <code>min_samples_leaf</code>, minimum size of data in one leaf (to avoid overfitting); (f) <code>learning_rate</code>, learning rate of the algorithm; (g) <code>n_iter_no_change</code>, number of successive iterations to stop training when validation metrics do not improve; (h) <code>validation_split</code>, fraction of training data to be used as validation data.</p>
<div class="sourceCode" id="cb263"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># install "lightgbm" package if not available</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="st"><a href="https://github.com/Microsoft/LightGBM">"lightgbm"</a></span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"lightgbm"</span><span class="op">)</span></span>
<span><span class="co"># create a function in sits style for LightGBM algorithm</span></span>
<span><span class="va">sits_lightgbm</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                          <span class="va">boosting_type</span> <span class="op">=</span> <span class="st">"gbdt"</span>,</span>
<span>                          <span class="va">objective</span> <span class="op">=</span> <span class="st">"multiclass"</span>,</span>
<span>                          <span class="va">min_samples_leaf</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                          <span class="va">max_depth</span> <span class="op">=</span> <span class="fl">6</span>,</span>
<span>                          <span class="va">learning_rate</span> <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>                          <span class="va">num_iterations</span> <span class="op">=</span> <span class="fl">100</span>,</span>
<span>                          <span class="va">n_iter_no_change</span> <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                          <span class="va">validation_split</span> <span class="op">=</span> <span class="fl">0.2</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># function that returns MASS::lda model based on a sits sample tibble</span></span>
<span>  <span class="va">train_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Extract the predictors</span></span>
<span>    <span class="va">train_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_predictors.html">sits_predictors</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># find number of labels</span></span>
<span>    <span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_labels.html">sits_labels</a></span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span>
<span>    <span class="va">n_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span></span>
<span>    <span class="co"># lightGBM uses numerical labels starting from 0</span></span>
<span>    <span class="va">int_labels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">n_labels</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span></span>
<span>    <span class="co"># create a named vector with integers match the class labels</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">int_labels</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">labels</span></span>
<span></span>
<span>    <span class="co"># add number of classes to lightGBM params</span></span>
<span>    <span class="co"># split the data into training and validation datasets</span></span>
<span>    <span class="co"># create partitions different splits of the input data</span></span>
<span>    <span class="va">test_samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_pred_sample.html">sits_pred_sample</a></span><span class="op">(</span><span class="va">train_samples</span>,</span>
<span>      frac <span class="op">=</span> <span class="va">validation_split</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Remove the lines used for validation</span></span>
<span>    <span class="va">sel</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="va">train_samples</span><span class="op">$</span><span class="va">sample_id</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="va">test_samples</span><span class="op">$</span><span class="va">sample_id</span><span class="op">)</span></span>
<span>    <span class="va">train_samples</span> <span class="op">&lt;-</span> <span class="va">train_samples</span><span class="op">[</span><span class="va">sel</span>, <span class="op">]</span></span>
<span></span>
<span>    <span class="co"># transform the training data to LGBM dataset</span></span>
<span>    <span class="va">lgbm_train_samples</span> <span class="op">&lt;-</span> <span class="fu">lightgbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.html">lgb.Dataset</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">train_samples</span><span class="op">[</span>, <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">int_labels</span><span class="op">[</span><span class="va">train_samples</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># transform the test data to LGBM dataset</span></span>
<span>    <span class="va">lgbm_test_samples</span> <span class="op">&lt;-</span> <span class="fu">lightgbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.Dataset.html">lgb.Dataset</a></span><span class="op">(</span></span>
<span>      data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">test_samples</span><span class="op">[</span>, <span class="op">-</span><span class="fl">2</span><span class="op">:</span><span class="fl">0</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html">unname</a></span><span class="op">(</span><span class="va">int_labels</span><span class="op">[</span><span class="va">test_samples</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># set the parameters for the lightGBM training</span></span>
<span>    <span class="va">lgb_params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>      boosting_type <span class="op">=</span> <span class="va">boosting_type</span>,</span>
<span>      objective <span class="op">=</span> <span class="va">objective</span>,</span>
<span>      min_samples_leaf <span class="op">=</span> <span class="va">min_samples_leaf</span>,</span>
<span>      max_depth <span class="op">=</span> <span class="va">max_depth</span>,</span>
<span>      learning_rate <span class="op">=</span> <span class="va">learning_rate</span>,</span>
<span>      num_iterations <span class="op">=</span> <span class="va">num_iterations</span>,</span>
<span>      n_iter_no_change <span class="op">=</span> <span class="va">n_iter_no_change</span>,</span>
<span>      num_class <span class="op">=</span> <span class="va">n_labels</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># call method and return the trained model</span></span>
<span>    <span class="va">lgbm_model</span> <span class="op">&lt;-</span> <span class="fu">lightgbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.train.html">lgb.train</a></span><span class="op">(</span></span>
<span>      data    <span class="op">=</span> <span class="va">lgbm_train_samples</span>,</span>
<span>      valids  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>test_data <span class="op">=</span> <span class="va">lgbm_test_samples</span><span class="op">)</span>,</span>
<span>      params  <span class="op">=</span> <span class="va">lgb_params</span>,</span>
<span>      verbose <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>      <span class="va">...</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co"># serialize the model for parallel processing</span></span>
<span>    <span class="va">lgbm_model_string</span> <span class="op">&lt;-</span> <span class="va">lgbm_model</span><span class="op">$</span><span class="fu">save_model_to_string</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span>    <span class="co"># construct model predict closure function and returns</span></span>
<span>    <span class="va">predict_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">values</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># reload the model (unserialize)</span></span>
<span>      <span class="va">lgbm_model</span> <span class="op">&lt;-</span> <span class="fu">lightgbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.load.html">lgb.load</a></span><span class="op">(</span>model_str <span class="op">=</span> <span class="va">lgbm_model_string</span><span class="op">)</span></span>
<span>      <span class="co"># predict probabilities</span></span>
<span>      <span class="va">prediction</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">lgbm_model</span>,</span>
<span>        data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">as.matrix</a></span><span class="op">(</span><span class="va">values</span><span class="op">)</span>,</span>
<span>        rawscore <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        reshape <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="co"># adjust the names of the columns of the probs</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">labels</span></span>
<span>      <span class="co"># retrieve the prediction results</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">prediction</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># Set model class</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">predict_fun</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lightgbm_model"</span>, <span class="st">"sits_model"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">predict_fun</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">predict_fun</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_factory_function.html">sits_factory_function</a></span><span class="op">(</span><span class="va">samples</span>, <span class="va">train_fun</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The above code has two nested functions: <code>train_fun()</code> and <code>predict_fun()</code>. When <code>sits_lightgbm()</code> is called, <code>train_fun()</code> transforms the input samples into predictors and uses them to train the algorithm, creating a model (<code>lgbm_model</code>). This model is included as part of the function’s closure and becomes available at classification time. Inside <code>train_fun()</code>, we include <code>predict_fun()</code>, which applies the <code>lgbm_model</code> object to classify to the input values. The <code>train_fun</code> object is then returned as a closure, using the <code>sits_factory_function</code> constructor. This function allows the model to be called either as part of <code><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train()</a></code> or to be called independently, with the same result.</p>
<div class="sourceCode" id="cb264"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sits_factory_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">fun</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># if no data is given, we prepare a</span></span>
<span>  <span class="co"># function to be called as a parameter of other functions</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu">purrr</span><span class="fu">::</span><span class="fu">is_null</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="va">fun</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co"># ...otherwise compute the result on the input data</span></span>
<span>    <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">fun</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>As a result, the following calls are equivalent.</p>
<div class="sourceCode" id="cb265"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># building a model using sits_train</span></span>
<span><span class="va">lgbm_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train</a></span><span class="op">(</span><span class="va">samples</span>, <span class="fu">sits_lightgbm</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># building a model directly</span></span>
<span><span class="va">lgbm_model</span> <span class="op">&lt;-</span> <span class="fu">sits_lightgbm</span><span class="op">(</span><span class="va">samples</span><span class="op">)</span></span></code></pre></div>
<p>There is one additional requirement for the algorithm to be compatible with <code>sits</code>. Data cube processing algorithms in <code>sits</code> run in parallel. For this reason, once the classification model is trained, it is serialized, as shown in the following line. The serialized version of the model is exported to the function closure, so it can be used at classification time.</p>
<div class="sourceCode" id="cb266"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># serialize the model for parallel processing</span></span>
<span><span class="va">lgbm_model_string</span> <span class="op">&lt;-</span> <span class="va">lgbm_model</span><span class="op">$</span><span class="fu">save_model_to_string</span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<p>During classification, <code>predict_fun()</code> is called in parallel by each CPU. At this moment, the serialized string is transformed back into a model, which is then run to obtain the classification, as shown in the code.</p>
<div class="sourceCode" id="cb267"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># unserialize the model</span></span>
<span><span class="va">lgbm_model</span> <span class="op">&lt;-</span> <span class="fu">lightgbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lightgbm/man/lgb.load.html">lgb.load</a></span><span class="op">(</span>model_str <span class="op">=</span> <span class="va">lgbm_model_string</span><span class="op">)</span></span></code></pre></div>
<p>Therefore, using function factories that produce closures, <code>sits</code> keeps the classification function independent of the machine learning or deep learning algorithm. This policy allows independent proposal, testing, and development of new classification methods. It also enables improvements on parallel processing methods without affecting the existing classification methods.</p>
<p>To illustrate this separation between training and classification, the new algorithm developed in the chapter using <code>lightgbm</code> will be used to classify a data cube. The code is the same as the one in Chapter <a href="https://e-sensing.github.io/sitsbook/introduction.html">Introduction</a> as an example of data cube classification, except for the use of <code>lgb_method()</code>.</p>
<div class="sourceCode" id="cb268"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"samples_matogrosso_mod13q1"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span></span>
<span><span class="co"># Create a data cube using local files</span></span>
<span><span class="va">sinop</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source <span class="op">=</span> <span class="st">"BDC"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"MOD13Q1-6.1"</span>,</span>
<span>  data_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/sinop"</span>, package <span class="op">=</span> <span class="st">"sitsdata"</span><span class="op">)</span>,</span>
<span>  parse_info <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"X1"</span>, <span class="st">"X2"</span>, <span class="st">"tile"</span>, <span class="st">"band"</span>, <span class="st">"date"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># The data cube has only "NDVI" and "EVI" bands</span></span>
<span><span class="co"># Select the bands NDVI and EVI</span></span>
<span><span class="va">samples_2bands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_select.html">sits_select</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">samples_matogrosso_mod13q1</span>,</span>
<span>  bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NDVI"</span>, <span class="st">"EVI"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># train lightGBM model</span></span>
<span><span class="va">lgb_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train</a></span><span class="op">(</span><span class="va">samples_2bands</span>, <span class="fu">sits_lightgbm</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Classify the data cube</span></span>
<span><span class="va">sinop_probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">sinop</span>,</span>
<span>  ml_model <span class="op">=</span> <span class="va">lgb_model</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  memsize <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp15"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Perform spatial smoothing</span></span>
<span><span class="va">sinop_bayes</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_smooth.html">sits_smooth</a></span><span class="op">(</span></span>
<span>  cube <span class="op">=</span> <span class="va">sinop_probs</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  memsize <span class="op">=</span> <span class="fl">8</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp15"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Label the smoothed file</span></span>
<span><span class="va">sinop_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification</a></span><span class="op">(</span></span>
<span>  cube <span class="op">=</span> <span class="va">sinop_bayes</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="st">"./tempdir/chp15"</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># plot the result</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">sinop_map</span>, title <span class="op">=</span> <span class="st">"Sinop Classification Map"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:maplgbm"></span>
<img src="16-annex_files/figure-html/maplgbm-1.png" alt="Classification map for Sinop using LightGBM (source: authors)." width="100%"><p class="caption">
Figure 120: Classification map for Sinop using LightGBM (source: authors).
</p>
</div>
</div>
</div>
<div id="how-parallel-processing-works-in-virtual-machines-with-cpus" class="section level2 unnumbered">
<h2>How parallel processing works in virtual machines with CPUs<a class="anchor" aria-label="anchor" href="#how-parallel-processing-works-in-virtual-machines-with-cpus"><i class="fas fa-link"></i></a>
</h2>
<p>This section provides an overview of how <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code>, <code><a href="https://rdrr.io/pkg/sits/man/sits_smooth.html">sits_smooth()</a></code>, and <code><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification()</a></code> process images in parallel. To achieve efficiency, <code>sits</code> implements a fault-tolerant multitasking procedure for big Earth observation data classification. The learning curve is shortened as there is no need to learn how to do multiprocessing. Image classification in <code>sits</code> is done by a cluster of independent workers linked to a virtual machine. To avoid communication overhead, all large payloads are read and stored independently; direct interaction between the main process and the workers is kept at a minimum.</p>
<p>The classification procedure benefits from the fact that most images available in cloud collections are stored as COGs (cloud-optimized GeoTIFF). COGs are regular GeoTIFF files organized in regular square blocks to improve visualization and access for large datasets. Thus, data requests can be optimized to access only portions of the images. All cloud services supported by <code>sits</code> use COG files. The classification algorithm in <code>sits</code> uses COGs to ensure optimal data access, reducing I/O demand as much as possible.</p>
<p>The approach for parallel processing in <code>sits</code>, depicted in Figure <a href="technical-annex.html#fig:par">121</a>, has the following steps:</p>
<ol style="list-style-type: decimal">
<li>Based on the block size of individual COG files, calculate the size of each chunk that must be loaded in memory, considering the number of bands and the timeline’s length. Chunk access is optimized for the efficient transfer of data blocks.</li>
<li>Divide the total memory available by the chunk size to determine how many processes can run in parallel.</li>
<li>Each core processes a chunk and produces a subset of the result.</li>
<li>Repeat the process until all chunks in the cube have been processed.</li>
<li>Check that subimages have been produced correctly. If there is a problem with one or more subimages, run a failure recovery procedure to ensure all data is processed.</li>
<li>After generating all subimages, join them to obtain the result.</li>
</ol>
<div class="figure" style="text-align: center">
<span style="display:block;" id="fig:par"></span>
<img src="images/sits_parallel.png" alt="Parallel processing in sits (Source: Simoes et al. (2021).  Reproduction under fair use doctrine)." width="90%" height="90%"><p class="caption">
Figure 121: Parallel processing in sits (Source: Simoes et al. (2021). Reproduction under fair use doctrine).
</p>
</div>
<p>This approach has many advantages. It has no dependencies on proprietary software and runs in any virtual machine that supports R. Processing is done in a concurrent and independent way, with no communication between workers. Failure of one worker does not cause the failure of big data processing. The software is prepared to resume classification processing from the last processed chunk, preventing failures such as memory exhaustion, power supply interruption, or network breakdown.</p>
<p>To reduce processing time, it is necessary to adjust <code><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify()</a></code>, <code><a href="https://rdrr.io/pkg/sits/man/sits_smooth.html">sits_smooth()</a></code>, and <code><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification()</a></code> according to the capabilities of the host environment. The <code>memsize</code> parameter controls the size of the main memory (in GBytes) to be used for classification. A practical approach is to set <code>memsize</code> to the maximum memory available in the virtual machine for classification and to choose <code>multicores</code> as the largest number of cores available. Based on the memory available and the size of blocks in COG files, <code>sits</code> will access the images in an optimized way. In this way, <code>sits</code> tries to ensure the best possible use of the available resources.</p>
</div>
<div id="exporting-data-to-json" class="section level2 unnumbered">
<h2>Exporting data to JSON<a class="anchor" aria-label="anchor" href="#exporting-data-to-json"><i class="fas fa-link"></i></a>
</h2>
<p>Both the data cube and the time series tibble can be exported to exchange formats such as JSON.</p>
<div class="sourceCode" id="cb269"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://jeroen.r-universe.dev/jsonlite">jsonlite</a></span><span class="op">)</span></span>
<span><span class="co"># Export the data cube to JSON</span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/read_json.html">write_json</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">sinop</span>,</span>
<span>  path <span class="op">=</span> <span class="st">"./data_cube.json"</span>,</span>
<span>  pretty <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Export the time series to JSON</span></span>
<span><span class="fu">jsonlite</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/jsonlite/man/read_json.html">write_json</a></span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="va">samples_prodes_4classes</span>,</span>
<span>  path <span class="op">=</span> <span class="st">"./time_series.json"</span>,</span>
<span>  pretty <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div id="sits-and-google-earth-engine-apis-a-side-by-side-exploration" class="section level2 unnumbered">
<h2>SITS and Google Earth Engine APIs: A side-by-side exploration<a class="anchor" aria-label="anchor" href="#sits-and-google-earth-engine-apis-a-side-by-side-exploration"><i class="fas fa-link"></i></a>
</h2>
<p>This section presents a side-by-side exploration of the <code>sits</code> and Google Earth
Engine (<code>gee</code>) APIs, focusing on their respective capabilities in handling
satellite data. The exploration is structured around three key examples:
(1) creating a mosaic, (2) calculating the Normalized Difference Vegetation
Index (NDVI), and (3) performing a Land Use and Land Cover (LULC) classification.
Each example demonstrates how these tasks are executed using <code>sits</code> and <code>gee</code>,
offering a clear view of their methodologies and highlighting the similarities
and the unique approaches each API employs.</p>
<div id="example-1-creating-a-mosaic" class="section level3 unnumbered">
<h3>Example 1: Creating a Mosaic<a class="anchor" aria-label="anchor" href="#example-1-creating-a-mosaic"><i class="fas fa-link"></i></a>
</h3>
<p>A common application among scientists and developers in the field of Remote
Sensing is the creation of satellite image mosaics. These mosaics are formed by
combining two or more images, typically used for visualization in various
applications. In this example, we will demonstrate how to create an image
mosaic using <code>sits</code> and <code>gee</code> APIs.</p>
<p>In this example, a Region of Interest (ROI) is defined using a bounding box
with longitude and latitude coordinates. Below are the code snippets for
specifying this ROI in both <code>sits</code> and <code>gee</code> environments.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb270"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"lon_min"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">63.410</span>, <span class="st">"lat_min"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.783</span>,</span>
<span>  <span class="st">"lon_max"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">62.614</span>, <span class="st">"lat_max"</span> <span class="op">=</span> <span class="op">-</span><span class="fl">9.331</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb271"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb271-1"><a href="technical-annex.html#cb271-1" tabindex="-1"></a><span class="kw">var</span> roi <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Rectangle</span>([<span class="op">-</span><span class="fl">63.410</span><span class="op">,-</span><span class="fl">9.783</span><span class="op">,-</span><span class="fl">62.614</span><span class="op">,-</span><span class="fl">9.331</span>])<span class="op">;</span></span></code></pre></div>
<p>Next, we will load the satellite imagery. For this example, we used data from <a href="https://sentinels.copernicus.eu/web/sentinel/copernicus/sentinel-2">Sentinel-2</a>.
In <code>sits</code>, several providers offer Sentinel-2 ARD images. In this example,
we will use images provided by the Microsoft Planetary Computer (<strong>MPC</strong>).</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb272"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source     <span class="op">=</span> <span class="st">"MPC"</span>,</span>
<span>  collection <span class="op">=</span> <span class="st">"SENTINEL-2-L2A"</span>,</span>
<span>  bands      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B02"</span>, <span class="st">"B03"</span>, <span class="st">"B04"</span><span class="op">)</span>,</span>
<span>  tiles      <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"20LNQ"</span>, <span class="st">"20LMQ"</span><span class="op">)</span>,</span>
<span>  start_date <span class="op">=</span> <span class="st">"2024-08-01"</span>,</span>
<span>  end_date   <span class="op">=</span> <span class="st">"2024-08-03"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb273"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb273-1"><a href="technical-annex.html#cb273-1" tabindex="-1"></a><span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">'COPERNICUS/S2_SR_HARMONIZED'</span>)</span>
<span id="cb273-2"><a href="technical-annex.html#cb273-2" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">'2024-08-01'</span><span class="op">,</span> <span class="st">'2024-08-03'</span>)</span>
<span id="cb273-3"><a href="technical-annex.html#cb273-3" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">inList</span>(<span class="st">'MGRS_TILE'</span><span class="op">,</span> [<span class="st">'20LNQ'</span><span class="op">,</span> <span class="st">'20LMQ'</span>]))</span>
<span id="cb273-4"><a href="technical-annex.html#cb273-4" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">'B4'</span><span class="op">,</span> <span class="st">'B3'</span><span class="op">,</span> <span class="st">'B2'</span>])<span class="op">;</span></span></code></pre></div>
<blockquote>
<p><code>sits</code> provides search filters for a collection as parameters in the
<code><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube()</a></code> function, whereas <code>gee</code> offers these filters as methods of an
<code>ImageCollection</code> object.</p>
</blockquote>
<p>In <code>sits</code>, we will use the <code><a href="https://rdrr.io/pkg/sits/man/sits_mosaic.html">sits_mosaic()</a></code> function to create mosaics of our
images. In <code>gee</code>, we will utilize the <code>mosaic()</code> method.
<code><a href="https://rdrr.io/pkg/sits/man/sits_mosaic.html">sits_mosaic()</a></code> function crops the mosaic based on the <code>roi</code> parameter.
In <code>gee</code>, cropping is performed using the <code><a href="https://rdrr.io/r/graphics/clip.html">clip()</a></code> method.
We will use the same <code>roi</code> that was used to filter the images to perform
the cropping on the mosaic. See the following code:</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb274"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mosaic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_mosaic.html">sits_mosaic</a></span><span class="op">(</span></span>
<span>  cube       <span class="op">=</span> <span class="va">data</span>,</span>
<span>  roi        <span class="op">=</span> <span class="va">roi</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb275"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb275-1"><a href="technical-annex.html#cb275-1" tabindex="-1"></a><span class="kw">var</span> mosaic <span class="op">=</span> data<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(roi)<span class="op">;</span></span></code></pre></div>
<p>Finally, the results can be visualized in an interactive map.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb276"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_view.html">sits_view</a></span><span class="op">(</span></span>
<span>  x     <span class="op">=</span> <span class="va">mosaic</span>,</span>
<span>  red   <span class="op">=</span> <span class="st">"B04"</span>,</span>
<span>  green <span class="op">=</span> <span class="st">"B03"</span>,</span>
<span>  blue  <span class="op">=</span> <span class="st">"B02"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/mosaic-sits.png" width="100%" height="50%"></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb277"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb277-1"><a href="technical-annex.html#cb277-1" tabindex="-1"></a><span class="co">// Define view region</span></span>
<span id="cb277-2"><a href="technical-annex.html#cb277-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(roi<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb277-3"><a href="technical-annex.html#cb277-3" tabindex="-1"></a></span>
<span id="cb277-4"><a href="technical-annex.html#cb277-4" tabindex="-1"></a><span class="co">// Add mosaic Image</span></span>
<span id="cb277-5"><a href="technical-annex.html#cb277-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mosaic<span class="op">,</span> {</span>
<span id="cb277-6"><a href="technical-annex.html#cb277-6" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb277-7"><a href="technical-annex.html#cb277-7" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span></span>
<span id="cb277-8"><a href="technical-annex.html#cb277-8" tabindex="-1"></a>}<span class="op">,</span> <span class="st">'Mosaic'</span>)<span class="op">;</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/mosaic-gee.png" width="100%" height="50%"></div>
</div>
<div id="example-2-calculating-ndvi" class="section level3 unnumbered">
<h3>Example 2: Calculating NDVI<a class="anchor" aria-label="anchor" href="#example-2-calculating-ndvi"><i class="fas fa-link"></i></a>
</h3>
<p>This example demonstrates how to generate time-series of Normalized Difference
Vegetation Index (NDVI) using both the <code>sits</code> and <code>gee</code> APIs.</p>
<p>In this example, a Region of Interest (ROI) is defined using the <code>sinop_roi.shp</code>
file. Below are the code snippets for specifying this file in both <code>sits</code> and
<code>gee</code> environments.</p>
<blockquote>
<p>To reproduce the example, you can download the shapefile using <a href="data/sits-gee/sinop_roi.zip">this link</a>.
In <code>sits</code>, you can just use it. In <code>gee</code>, it would be required to upload the
file in your user space.</p>
</blockquote>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb278"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="st">"sinop_roi.shp"</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb279"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb279-1"><a href="technical-annex.html#cb279-1" tabindex="-1"></a><span class="kw">var</span> roi_data <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">"/path/to/sinop_roi"</span>)<span class="op">;</span></span></code></pre></div>
<p>Next, we load the satellite imagery. For this example, we use data from <a href="https://www.usgs.gov/landsat-missions/landsat-8">Landsat-8</a>.
In <code>sits</code>, this data is retrieved from the Brazil Data Cube, although
other sources are available. For <code>gee</code>, the data provided by the platform is used.</p>
<p>In <code>sits</code>, when the data is loaded, all necessary transformations to make the
data ready for use (e.g., <code>factor</code>, <code>offset</code>, <code>cloud masking</code>) are applied
automatically. In <code>gee</code>, users are responsible for performing these
transformations themselves.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb280"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>  source      <span class="op">=</span> <span class="st">"BDC"</span>,</span>
<span>  collection  <span class="op">=</span> <span class="st">"LANDSAT-OLI-16D"</span>,</span>
<span>  bands       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RED"</span>, <span class="st">"NIR08"</span>, <span class="st">"CLOUD"</span><span class="op">)</span>,</span>
<span>  roi         <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>  start_date  <span class="op">=</span> <span class="st">"2019-05-01"</span>,</span>
<span>  end_date    <span class="op">=</span> <span class="st">"2019-07-01"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb281"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb281-1"><a href="technical-annex.html#cb281-1" tabindex="-1"></a><span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">"LANDSAT/LC08/C02/T1_L2"</span>)</span>
<span id="cb281-2"><a href="technical-annex.html#cb281-2" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterBounds</span>(roi_data)</span>
<span id="cb281-3"><a href="technical-annex.html#cb281-3" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">"2019-05-01"</span><span class="op">,</span> <span class="st">"2019-07-01"</span>)</span>
<span id="cb281-4"><a href="technical-annex.html#cb281-4" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">"SR_B4"</span><span class="op">,</span> <span class="st">"SR_B5"</span><span class="op">,</span> <span class="st">"QA_PIXEL"</span>])<span class="op">;</span></span>
<span id="cb281-5"><a href="technical-annex.html#cb281-5" tabindex="-1"></a></span>
<span id="cb281-6"><a href="technical-annex.html#cb281-6" tabindex="-1"></a><span class="co">// factor and offset</span></span>
<span id="cb281-7"><a href="technical-annex.html#cb281-7" tabindex="-1"></a>data <span class="op">=</span> data<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb281-8"><a href="technical-annex.html#cb281-8" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">'SR_B.'</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb281-9"><a href="technical-annex.html#cb281-9" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb281-10"><a href="technical-annex.html#cb281-10" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb281-11"><a href="technical-annex.html#cb281-11" tabindex="-1"></a></span>
<span id="cb281-12"><a href="technical-annex.html#cb281-12" tabindex="-1"></a>data <span class="op">=</span> data<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb281-13"><a href="technical-annex.html#cb281-13" tabindex="-1"></a>  <span class="co">// Select the pixel_qa band</span></span>
<span id="cb281-14"><a href="technical-annex.html#cb281-14" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">'QA_PIXEL'</span>)<span class="op">;</span></span>
<span id="cb281-15"><a href="technical-annex.html#cb281-15" tabindex="-1"></a></span>
<span id="cb281-16"><a href="technical-annex.html#cb281-16" tabindex="-1"></a>  <span class="co">// Create a mask to identify cloud and cloud shadow</span></span>
<span id="cb281-17"><a href="technical-annex.html#cb281-17" tabindex="-1"></a>  <span class="kw">var</span> cloudMask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">5</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>) <span class="co">// Clouds</span></span>
<span id="cb281-18"><a href="technical-annex.html#cb281-18" tabindex="-1"></a>           <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">3</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span> <span class="co">// Cloud shadows</span></span>
<span id="cb281-19"><a href="technical-annex.html#cb281-19" tabindex="-1"></a></span>
<span id="cb281-20"><a href="technical-annex.html#cb281-20" tabindex="-1"></a>  <span class="co">// Apply the cloud mask to the image</span></span>
<span id="cb281-21"><a href="technical-annex.html#cb281-21" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(cloudMask)<span class="op">;</span></span>
<span id="cb281-22"><a href="technical-annex.html#cb281-22" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>After loading the satellite imagery, the NDVI can be generated. In <code>sits</code>, a
function allows users to specify the formula used to create a new attribute,
in this case, NDVI. In <code>gee</code>, a callback function is used, where the NDVI is
calculated for each image.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb282"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_ndvi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_apply.html">sits_apply</a></span><span class="op">(</span></span>
<span>  data        <span class="op">=</span> <span class="va">data</span>,</span>
<span>  NDVI        <span class="op">=</span> <span class="op">(</span><span class="va">NIR08</span> <span class="op">-</span> <span class="va">RED</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">NIR08</span> <span class="op">+</span> <span class="va">RED</span><span class="op">)</span>,</span>
<span>  output_dir  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  multicores  <span class="op">=</span> <span class="fl">4</span>,</span>
<span>  progress    <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb283"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb283-1"><a href="technical-annex.html#cb283-1" tabindex="-1"></a><span class="kw">var</span> data_ndvi <span class="op">=</span> data<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb283-2"><a href="technical-annex.html#cb283-2" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">"SR_B5"</span><span class="op">,</span> <span class="st">"SR_B4"</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">'NDVI'</span>)<span class="op">;</span></span>
<span id="cb283-3"><a href="technical-annex.html#cb283-3" tabindex="-1"></a></span>
<span id="cb283-4"><a href="technical-annex.html#cb283-4" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb283-5"><a href="technical-annex.html#cb283-5" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb283-6"><a href="technical-annex.html#cb283-6" tabindex="-1"></a></span>
<span id="cb283-7"><a href="technical-annex.html#cb283-7" tabindex="-1"></a>data_ndvi <span class="op">=</span> data_ndvi<span class="op">.</span><span class="fu">select</span>(<span class="st">"NDVI"</span>)<span class="op">;</span></span></code></pre></div>
<p>The results are clipped to the ROI defined at the beginning of the
example to facilitate visualization.</p>
<blockquote>
<p>In both APIs, you can define a ROI before performing the
operation to optimize resource usage. However, in this example, the data is
cropped after the calculation.</p>
</blockquote>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb284"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_ndvi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_mosaic.html">sits_mosaic</a></span><span class="op">(</span></span>
<span>  cube       <span class="op">=</span> <span class="va">data_ndvi</span>,</span>
<span>  roi        <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>  output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  multicores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb285"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb285-1"><a href="technical-annex.html#cb285-1" tabindex="-1"></a>data_ndvi <span class="op">=</span> data_ndvi<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb285-2"><a href="technical-annex.html#cb285-2" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">clip</span>(roi_data)<span class="op">;</span></span>
<span id="cb285-3"><a href="technical-annex.html#cb285-3" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Finally, the results can be visualized in an interactive map.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb286"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_view.html">sits_view</a></span><span class="op">(</span><span class="va">data_ndvi</span>, band <span class="op">=</span> <span class="st">"NDVI"</span>, date <span class="op">=</span> <span class="st">"2019-05-25"</span>, opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/ndvi-sits.png" width="100%" height="50%"></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb287"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb287-1"><a href="technical-annex.html#cb287-1" tabindex="-1"></a><span class="co">// Define view region</span></span>
<span id="cb287-2"><a href="technical-annex.html#cb287-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(roi_data<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb287-3"><a href="technical-annex.html#cb287-3" tabindex="-1"></a></span>
<span id="cb287-4"><a href="technical-annex.html#cb287-4" tabindex="-1"></a><span class="co">// Add classification map (colors from sits)</span></span>
<span id="cb287-5"><a href="technical-annex.html#cb287-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(data_ndvi<span class="op">,</span> {</span>
<span id="cb287-6"><a href="technical-annex.html#cb287-6" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> </span>
<span id="cb287-7"><a href="technical-annex.html#cb287-7" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> </span>
<span id="cb287-8"><a href="technical-annex.html#cb287-8" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> [<span class="st">"red"</span><span class="op">,</span> <span class="st">'white'</span><span class="op">,</span> <span class="st">'green'</span>]</span>
<span id="cb287-9"><a href="technical-annex.html#cb287-9" tabindex="-1"></a>}<span class="op">,</span> <span class="st">"NDVI Image"</span>)<span class="op">;</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/ndvi-gee.png" width="100%" height="50%"></div>
</div>
<div id="example-3-land-use-and-land-cover-lulc-classification" class="section level3 unnumbered">
<h3>Example 3: Land Use and Land Cover (LULC) Classification<a class="anchor" aria-label="anchor" href="#example-3-land-use-and-land-cover-lulc-classification"><i class="fas fa-link"></i></a>
</h3>
<p>This example demonstrates how to perform Land Use and Land Cover (LULC)
classification using satellite image time series and machine-learning models in
both <code>sits</code> and <code>gee</code>.</p>
<p>This example defines the region of interest (ROI) using a shapefile named
<code>sinop_roi.shp</code>. Below are the code snippets for specifying this file in both
<code>sits</code> and <code>gee</code> environments.</p>
<blockquote>
<p>To reproduce the example, you can download the shapefile using <a href="data/sits-gee/sinop_roi.zip">this link</a>.
In <code>sits</code>, you can just use it. In <code>gee</code>, it would be required to upload the
file in your user space.</p>
</blockquote>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb288"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">roi_data</span> <span class="op">&lt;-</span> <span class="st">"sinop_roi.shp"</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb289"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb289-1"><a href="technical-annex.html#cb289-1" tabindex="-1"></a><span class="kw">var</span> roi_data <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">"/path/to/sinop_roi"</span>)<span class="op">;</span></span></code></pre></div>
<p>To train a classifier, sample data with labels representing the behavior of
each class to be identified is necessary. In this example, we use a small set
with <code>18</code> samples. The following code snippets show how these samples are defined
in each environment.</p>
<p>In <code>sits</code>, labels can be of type <code>string</code>, whereas <code>gee</code> requires labels to be
<code>integers</code>. To accommodate this difference, two versions of the same sample set
were created: (1) one with <code>string</code> labels for use with <code>sits</code>, and (2) another
with <code>integer</code> labels for use with <code>gee</code>.</p>
<blockquote>
<p>To download these samples, you can use the following links:
<a href="data/sits-gee/samples_sinop_crop.zip">samples_sinop_crop for sits</a> or <a href="data/sits-gee/samples_sinop_crop_gee.zip">samples_sinop_crop for gee</a></p>
</blockquote>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb290"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="st">"samples_sinop_crop.shp"</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb291"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb291-1"><a href="technical-annex.html#cb291-1" tabindex="-1"></a><span class="kw">var</span> samples <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">"samples_sinop_crop_gee"</span>)<span class="op">;</span></span></code></pre></div>
<p>Next, we load the satellite imagery. For this example, we use data from <a href="https://ladsweb.modaps.eosdis.nasa.gov/missions-and-measurements/products/MOD13Q1">MOD13Q1</a> .
In <code>sits</code>, this data is retrieved from the Brazil Data Cube, but other
sources are also available. In <code>gee</code>, the platform directly provides this data.</p>
<p>In <code>sits</code>, all necessary data transformations for classification tasks are
handled automatically. In contrast, <code>gee</code> requires users to manually transform
the data into the correct format.</p>
<p>In this context it’s important to note that, in the <code>gee</code> code, transforming all
images into bands mimics the approach used by <code>sits</code> for non-temporal classifiers.
However, this method is not inherently scalable in <code>gee</code> and may need adjustments
for larger datasets or more bands. Additionally, for temporal classifiers like
TempCNN, other transformations are necessary and must be manually implemented by
the user in <code>gee</code>.</p>
<p>In contrast, <code>sits</code> provides a consistent API experience, regardless of the data
size or machine learning algorithm.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb292"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_cube.html">sits_cube</a></span><span class="op">(</span></span>
<span>    source      <span class="op">=</span> <span class="st">"BDC"</span>,</span>
<span>    collection  <span class="op">=</span> <span class="st">"MOD13Q1-6.1"</span>,</span>
<span>    bands       <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"NDVI"</span><span class="op">)</span>,</span>
<span>    roi         <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>    start_date  <span class="op">=</span> <span class="st">"2013-09-01"</span>,</span>
<span>    end_date    <span class="op">=</span> <span class="st">"2014-08-29"</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb293"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb293-1"><a href="technical-annex.html#cb293-1" tabindex="-1"></a><span class="kw">var</span> data <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">"MODIS/061/MOD13Q1"</span>)</span>
<span id="cb293-2"><a href="technical-annex.html#cb293-2" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterBounds</span>(roi_data)</span>
<span id="cb293-3"><a href="technical-annex.html#cb293-3" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">"2013-09-01"</span><span class="op">,</span> <span class="st">"2014-09-01"</span>)</span>
<span id="cb293-4"><a href="technical-annex.html#cb293-4" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">"NDVI"</span>])<span class="op">;</span></span>
<span id="cb293-5"><a href="technical-annex.html#cb293-5" tabindex="-1"></a></span>
<span id="cb293-6"><a href="technical-annex.html#cb293-6" tabindex="-1"></a><span class="co">// Transform all images to bands</span></span>
<span id="cb293-7"><a href="technical-annex.html#cb293-7" tabindex="-1"></a>data <span class="op">=</span> data<span class="op">.</span><span class="fu">toBands</span>()<span class="op">;</span></span></code></pre></div>
<p>In this example, we’ll use a Random Forest classifier to create a LULC map. To
train the classifier, we need sample data linked to time-series.</p>
<p>This step shows how to extract and associate time-series with samples.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb294"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples_ts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_get_data.html">sits_get_data</a></span><span class="op">(</span></span>
<span>    cube       <span class="op">=</span> <span class="va">data</span>,</span>
<span>    samples    <span class="op">=</span> <span class="va">samples</span>,</span>
<span>    multicores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb295"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb295-1"><a href="technical-annex.html#cb295-1" tabindex="-1"></a><span class="kw">var</span> samples_ts <span class="op">=</span> data<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb295-2"><a href="technical-annex.html#cb295-2" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> samples<span class="op">,</span></span>
<span id="cb295-3"><a href="technical-annex.html#cb295-3" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">"label"</span>]</span>
<span id="cb295-4"><a href="technical-annex.html#cb295-4" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>With the time-series data extracted for each sample, we can now train the Random
Forest classifier</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb296"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">classifier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_train.html">sits_train</a></span><span class="op">(</span></span>
<span>    <span class="va">samples_ts</span>, <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_rfor.html">sits_rfor</a></span><span class="op">(</span>num_trees <span class="op">=</span> <span class="fl">100</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb297"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb297-1"><a href="technical-annex.html#cb297-1" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">100</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb297-2"><a href="technical-annex.html#cb297-2" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> samples_ts<span class="op">,</span></span>
<span id="cb297-3"><a href="technical-annex.html#cb297-3" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">"label"</span><span class="op">,</span></span>
<span id="cb297-4"><a href="technical-annex.html#cb297-4" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> data<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb297-5"><a href="technical-annex.html#cb297-5" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<p>Now, it is possible to generate the classification map using the trained Random
Forest model.</p>
<p>In <code>sits</code>, the classification process starts with a probability map.
This map provides the probability of each class for every pixel, offering insights
into the classifier’s performance. It also allows for refining the results using
methods like Bayesian probability smoothing. After generating the probability map,
it is possible to produce the class map, where each pixel is assigned to the class
with the highest probability.</p>
<p>In <code>gee</code>, while it is possible to generate probabilities, it is not strictly
required to produce the classification map. Yet, as of the date of this document,
there is no out-of-the-box solution available for utilizing these probabilities
to enhance classification results, as presented in <code>sits</code>.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb298"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">probabilities</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_classify.html">sits_classify</a></span><span class="op">(</span></span>
<span>    data       <span class="op">=</span> <span class="va">data</span>,</span>
<span>    ml_model   <span class="op">=</span> <span class="va">classifier</span>,</span>
<span>    multicores <span class="op">=</span> <span class="fl">4</span>,</span>
<span>    roi        <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>    output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">class_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_label_classification.html">sits_label_classification</a></span><span class="op">(</span></span>
<span>    cube       <span class="op">=</span> <span class="va">probabilities</span>,</span>
<span>    output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    multicores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb299"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb299-1"><a href="technical-annex.html#cb299-1" tabindex="-1"></a><span class="kw">var</span> probs_map <span class="op">=</span> data<span class="op">.</span><span class="fu">classify</span>(classifier<span class="op">.</span><span class="fu">setOutputMode</span>(<span class="st">"MULTIPROBABILITY"</span>))<span class="op">;</span></span>
<span id="cb299-2"><a href="technical-annex.html#cb299-2" tabindex="-1"></a><span class="kw">var</span> class_map <span class="op">=</span> data<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span></code></pre></div>
<p>The results are clipped to the ROI defined at the beginning of the example to
facilitate visualization.</p>
<blockquote>
<p>In both APIs, it’s possible to define an ROI before processing. However, this
was not applied in this example.</p>
</blockquote>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb300"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">class_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_mosaic.html">sits_mosaic</a></span><span class="op">(</span></span>
<span>    cube       <span class="op">=</span> <span class="va">class_map</span>,</span>
<span>    roi        <span class="op">=</span> <span class="va">roi_data</span>,</span>
<span>    output_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    multicores <span class="op">=</span> <span class="fl">4</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb301"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb301-1"><a href="technical-annex.html#cb301-1" tabindex="-1"></a>class_map <span class="op">=</span> class_map<span class="op">.</span><span class="fu">clip</span>(roi_data)<span class="op">;</span></span></code></pre></div>
<p>Finally, the results can be visualized on an interactive map.</p>
<p><strong>sits</strong></p>
<div class="sourceCode" id="cb302"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/sits/man/sits_view.html">sits_view</a></span><span class="op">(</span><span class="va">class_map</span>, opacity <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/classification-sits.png" width="100%" height="50%"></div>
<p><strong>gee</strong></p>
<div class="sourceCode" id="cb303"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb303-1"><a href="technical-annex.html#cb303-1" tabindex="-1"></a><span class="co">// Define view region</span></span>
<span id="cb303-2"><a href="technical-annex.html#cb303-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(roi_data<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb303-3"><a href="technical-annex.html#cb303-3" tabindex="-1"></a></span>
<span id="cb303-4"><a href="technical-annex.html#cb303-4" tabindex="-1"></a><span class="co">// Add classification map (colors from sits)</span></span>
<span id="cb303-5"><a href="technical-annex.html#cb303-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(class_map<span class="op">,</span> {</span>
<span id="cb303-6"><a href="technical-annex.html#cb303-6" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb303-7"><a href="technical-annex.html#cb303-7" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb303-8"><a href="technical-annex.html#cb303-8" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> [<span class="st">"#FAD12D"</span><span class="op">,</span> <span class="st">"#1E8449"</span><span class="op">,</span> <span class="st">"#D68910"</span><span class="op">,</span> <span class="st">"#a2d43f"</span>]</span>
<span id="cb303-9"><a href="technical-annex.html#cb303-9" tabindex="-1"></a>}<span class="op">,</span> <span class="st">"Classification map"</span>)<span class="op">;</span></span></code></pre></div>
<div class="inline-figure"><img src="images/sitsgee/classification-gee.png" width="100%" height="50%"></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="data-visualisation-in-sits.html">Data visualisation in sits</a></div>
<div class="next"><a href="references.html">References</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#technical-annex">Technical annex</a></li>
<li>
<a class="nav-link" href="#adding-functions-to-the-sits-api">Adding functions to the sits API</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#general-principles">General principles</a></li>
<li><a class="nav-link" href="#adherence-to-the-sits-data-types">Adherence to the sits data types</a></li>
<li><a class="nav-link" href="#literal-values-error-messages-and-testing">Literal values, error messages, and testing</a></li>
<li><a class="nav-link" href="#supporting-new-stac-based-image-catalogues">Supporting new STAC-based image catalogues</a></li>
<li><a class="nav-link" href="#including-new-methods-for-machine-learning">Including new methods for machine learning</a></li>
</ul>
</li>
<li><a class="nav-link" href="#how-parallel-processing-works-in-virtual-machines-with-cpus">How parallel processing works in virtual machines with CPUs</a></li>
<li><a class="nav-link" href="#exporting-data-to-json">Exporting data to JSON</a></li>
<li>
<a class="nav-link" href="#sits-and-google-earth-engine-apis-a-side-by-side-exploration">SITS and Google Earth Engine APIs: A side-by-side exploration</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#example-1-creating-a-mosaic">Example 1: Creating a Mosaic</a></li>
<li><a class="nav-link" href="#example-2-calculating-ndvi">Example 2: Calculating NDVI</a></li>
<li><a class="nav-link" href="#example-3-land-use-and-land-cover-lulc-classification">Example 3: Land Use and Land Cover (LULC) Classification</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong><strong>sits</strong>: Satellite Image Time Series Analysis on Earth Observation Data Cubes</strong>" was written by Gilberto Camara, Rolf Simoes, Felipe Souza, Felipe Menino, Charlotte Pelletier, Pedro R. Andrade, Karine Ferreira, Gilberto Queiroz. It was last built on 2024-09-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
